From 915dc4d8298b46da8d6ea6579a7555e552363b8b Mon Sep 17 00:00:00 2001
From: pramod kotreshappa <kpramod@codeaurora.org>
Date: Thu, 4 Oct 2018 03:14:41 -0700
Subject: [PATCH 06/10] TWS-A2DP: Add TWS+ codec index

Change-Id: I6f84643e152cfe9d9c2603e1fa7b257aca9d772a
CRs-Fixed: 2318635
---
 include/hardware/bt_av.h        | 4 ++++
 stack/a2dp/a2dp_codec_config.cc | 2 ++
 stack/a2dp/a2dp_vendor.cc       | 4 ++++
 stack/test/stack_a2dp_test.cc   | 6 ++++++
 4 files changed, 16 insertions(+)

diff --git a/include/hardware/bt_av.h b/include/hardware/bt_av.h
index 12e890327..dcc3760fe 100644
--- a/include/hardware/bt_av.h
+++ b/include/hardware/bt_av.h
@@ -55,6 +55,7 @@ typedef enum {
   BTAV_A2DP_CODEC_INDEX_SOURCE_APTX_HD,
   BTAV_A2DP_CODEC_INDEX_SOURCE_APTX_ADAPTIVE,
   BTAV_A2DP_CODEC_INDEX_SOURCE_LDAC,
+  BTAV_A2DP_CODEC_INDEX_SOURCE_APTX_TWS,
 
   BTAV_A2DP_CODEC_INDEX_SOURCE_MAX,
 
@@ -153,6 +154,9 @@ typedef struct {
       case BTAV_A2DP_CODEC_INDEX_SOURCE_LDAC:
         codec_name_str = "LDAC";
         break;
+      case BTAV_A2DP_CODEC_INDEX_SOURCE_APTX_TWS:
+        codec_name_str = "aptX TWS";
+        break;
       case BTAV_A2DP_CODEC_INDEX_SINK_SBC:
         codec_name_str = "SBC (Sink)";
         break;
diff --git a/stack/a2dp/a2dp_codec_config.cc b/stack/a2dp/a2dp_codec_config.cc
index 891583168..2480cdc66 100644
--- a/stack/a2dp/a2dp_codec_config.cc
+++ b/stack/a2dp/a2dp_codec_config.cc
@@ -136,6 +136,8 @@ A2dpCodecConfig* A2dpCodecConfig::createCodec(
     case BTAV_A2DP_CODEC_INDEX_SINK_LDAC:
       codec_config = new A2dpCodecConfigLdacSink(codec_priority);
       break;
+    case BTAV_A2DP_CODEC_INDEX_SOURCE_APTX_TWS:
+      break;
     case BTAV_A2DP_CODEC_INDEX_MAX:
       break;
   }
diff --git a/stack/a2dp/a2dp_vendor.cc b/stack/a2dp/a2dp_vendor.cc
index 991d822c8..804fcc9eb 100644
--- a/stack/a2dp/a2dp_vendor.cc
+++ b/stack/a2dp/a2dp_vendor.cc
@@ -601,6 +601,8 @@ const char* A2DP_VendorCodecIndexStr(btav_a2dp_codec_index_t codec_index) {
       return A2DP_VendorCodecIndexStrLdac();
     case BTAV_A2DP_CODEC_INDEX_SINK_LDAC:
       return A2DP_VendorCodecIndexStrLdacSink();
+    case BTAV_A2DP_CODEC_INDEX_SOURCE_APTX_TWS:
+      break;
     // Add a switch statement for each vendor-specific codec
     case BTAV_A2DP_CODEC_INDEX_MAX:
       break;
@@ -628,6 +630,8 @@ bool A2DP_VendorInitCodecConfig(btav_a2dp_codec_index_t codec_index,
       return A2DP_VendorInitCodecConfigLdac(p_cfg);
     case BTAV_A2DP_CODEC_INDEX_SINK_LDAC:
       return A2DP_VendorInitCodecConfigLdacSink(p_cfg);
+    case BTAV_A2DP_CODEC_INDEX_SOURCE_APTX_TWS:
+      break;
     // Add a switch statement for each vendor-specific codec
     case BTAV_A2DP_CODEC_INDEX_MAX:
       break;
diff --git a/stack/test/stack_a2dp_test.cc b/stack/test/stack_a2dp_test.cc
index ed8e457d4..bfe20c123 100644
--- a/stack/test/stack_a2dp_test.cc
+++ b/stack/test/stack_a2dp_test.cc
@@ -173,6 +173,7 @@ const uint8_t codec_info_non_a2dp_dummy[AVDT_CODEC_SIZE] = {
 static const char* APTX_ENCODER_LIB_NAME = "libaptX_encoder.so";
 static const char* APTX_HD_ENCODER_LIB_NAME = "libaptXHD_encoder.so";
 static const char* APTX_ADAPTIVE_ENCODER_LIB_NAME = "libaptXAdaptive_encoder.so";
+static const char* APTX_TWS_ENCODER_LIB_NAME = "libaptXTws_encoder.so";
 static const char* LDAC_ENCODER_LIB_NAME = "libldacBT_enc.so";
 static const char* LDAC_DECODER_LIB_NAME = "libldacBT_dec.so";
 
@@ -224,6 +225,11 @@ class StackA2dpTest : public ::testing::Test {
           // shared library installed.
           supported = has_shared_library(LDAC_ENCODER_LIB_NAME);
           break;
+        case BTAV_A2DP_CODEC_INDEX_SOURCE_APTX_TWS:
+          // Codec aptX-TWS is supported only if the device has the corresponding
+          // shared library installed.
+          supported = has_shared_library(APTX_TWS_ENCODER_LIB_NAME);
+          break;
         case BTAV_A2DP_CODEC_INDEX_SINK_SBC:
           supported = true;
           break;
-- 
2.28.0

